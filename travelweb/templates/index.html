{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A CLUB TRAVEL ‚Äî Index</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=2025-08-21-1">
</head>
<body>
  <!-- —Å–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º csrftoken –≤ DOM -->
  <form style="display:none">{% csrf_token %}</form>

  <!-- –ö–†–£–ì–õ–û–ï –§–û–ù–û–í–û–ï –í–ò–î–ï–û -->
  <div class="bg-circle" aria-hidden="true">
    <video id="bgCircleVideo"
           class="bg-circle__video"
           autoplay
           muted
           loop
           playsinline
           preload="metadata"
           poster="{% static 'img/bg-poster.jpg' %}">
      <source src="{% static 'video/bg-hero.mp4' %}" type="video/mp4">
    </video>
  </div>

  <!-- –®–∞–ø–∫–∞ -->
  <header class="topbar">
    <div class="container">
      <div class="greet">
        <div id="hi" class="hi">–°–∞–ª–æ–º, –º–µ“≥–º–æ–Ω üëã</div>
      </div>

      <div class="top-actions">
        <div class="weather" title="Local weather">
          <div class="icon" aria-hidden="true"></div>
          <div class="weatherTexts">
            <span id="weatherTextTop">Weather</span>
            <span id="weatherText">15¬∞C</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="container">
    <section class="layout">
      <div class="copy">
        <div class="copy-grid">
          <span id="locationBadge" class="badge">Loading location‚Ä¶</span>
          <h1 class="title" id="heroTitle">A CLUB<br/>TRAVEL</h1>
          <h1 class="titleDesc" id="heroTitleDesctop">A CLUB TRAVEL</h1>

          <!-- –¢—Ä–∏–≥–≥–µ—Ä –ø–æ–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞ -->
          <button class="search-trigger" id="searchTrigger" aria-label="Search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
              <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–∏—Å–∫–∞ -->
      <div class="search-overlay" id="searchOverlay" aria-hidden="true">
        <form class="search-bar" role="search" id="searchForm">
          <input class="search-field" id="searchField" type="text" placeholder="Search‚Ä¶" enterkeyhint="search" />
          <button type="button" class="search-close" id="searchClose" aria-label="Close">‚úï</button>
        </form>
      </div>
    </section>

    <!-- TRIPS SLIDER -->
    <section class="trips">
      <h2 class="trips-title">Popular trips</h2>

      <div class="trip-scroller" id="tripScroller" aria-label="Trip slider">
        {% for t in trips %}
        <article class="trip-card theme-{{ t.theme }}">
          <div class="trip-pill" aria-hidden="true"></div>
          <button class="trip-fav" aria-label="Add to favorites"></button>

          <div class="trip-top">
            <span class="flag">
              <img src="https://flagcdn.com/24x18/{{ t.country.iso2|lower }}.png" width="24" height="18" alt="">
              {{ t.country.name|upper }}
            </span>
          </div>

          <h3 class="trip-name">{{ t.title_full }}</h3>

          <div class="trip-meta">
            <div class="meta-col">
              <div class="cal">
                <i class="cal-ic" aria-hidden="true"></i>
                <span class="date">{{ t.date_range_str }}</span>
              </div>
              <div class="faces">
                <img src="https://i.pravatar.cc/48?img=12" alt="">
                <img src="https://i.pravatar.cc/48?img=32" alt="">
                <img src="https://i.pravatar.cc/48?img=18" alt="">
                <img src="https://i.pravatar.cc/48?img=44" alt="">
                <span class="more">+{{ t.booked }}</span>
              </div>
            </div>

            <a href="{% url 'travelapp:trip_detail' t.slug %}" class="trip-go" aria-label="Open trip"></a>
          </div>
        </article>
        {% empty %}
          <p style="opacity:.7">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤.</p>
        {% endfor %}
      </div>
    </section>
  </main>

  <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <div class="bottom-inner">
      <a class="tab tab--home active_page" href="{% url 'travelapp:index' %}"><span class="ico"></span></a>
      <a class="tab tab--support" href="#"><span class="ico"></span></a>
      <a class="tab tab--saved" href="#"><span class="ico"></span></a>
      <a class="tab tab--profile" href="#"><span class="ico" id="navAvatar"></span></a>
    </div>
  </nav>

  <!-- Desktop-only hint -->
  <div id="deviceHint" class="device-hint" role="dialog" aria-modal="true" aria-labelledby="deviceHintTitle" aria-describedby="deviceHintText">
    <div class="device-hint__card">
      <div class="device-hint__icon" aria-hidden="true">
        <svg viewBox="0 0 48 48" width="48" height="48">
          <rect x="14" y="4" width="20" height="40" rx="4" fill="#111"/>
          <rect x="16.5" y="8" width="15" height="28" rx="2" fill="#fff"/>
          <circle cx="24" cy="39" r="2.5" fill="#fff"/>
        </svg>
      </div>
      <h3 id="deviceHintTitle">–î–ª—è –ª—É—á—à–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∑–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
      <p id="deviceHintText" class="device-hint__sub">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
      <button id="deviceHintContinue" class="device-hint__btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –º–æ–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
    </div>
  </div>

<!-- ===== AUTH: TELEGRAM ONLY ===== -->
<div id="authTgModal" class="ac-modal hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="ac-modal__inner">
    <button class="ac-modal__close" data-close>&times;</button>

    <h3 id="authTitle" class="ac-title">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram</h3>
    <p class="ac-sub">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥ –≤ Telegram.</p>

    <div class="ac-tg">
      <!-- TELEGRAM LOGIN WIDGET -->
      <script async src="https://telegram.org/js/telegram-widget.js?22"
              data-telegram-login="{{ TELEGRAM_BOT_NAME|default:'travel_ayolclub_bot' }}"
              data-size="large"
              data-userpic="false"
              data-auth-url="/auth/telegram/callback/?next={{ request.path }}"
              data-request-access="write"></script>
    </div>

    <div class="ac-or"><span>–µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</span></div>
    <div class="ac-actions">
      <a class="btn btn-outline"
         href="https://t.me/{{ TELEGRAM_BOT_NAME|default:'travel_ayolclub_bot' }}?start=login"
         target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram</a>
    </div>

    <p class="ac-hint">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –≤–µ—Ä–Ω—ë—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
  </div>
</div>

  <!-- ===== AVATAR MODAL ===== -->
  <div id="avatarModal" class="ac-modal hidden" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
    <div class="ac-modal__inner">
      <button class="ac-modal__close" data-close>&times;</button>
      <h3 id="avatarTitle" class="ac-title" style="margin:0 0 10px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</h3>
      <p class="ac-sub">–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —É–∑–Ω–∞—Ç—å –≤–∞—Å.</p>
      <form id="formAvatar" class="ac-form" enctype="multipart/form-data">
        <input type="file" name="avatar" accept=".jpg,.jpeg,.png,.webp" required />
        <div class="ac-row">
          <button type="button" class="btn btn-ghost" data-close>–ü–æ–∑–∂–µ</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª–æ–∫ -->
<style>
  .ac-modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9999}
  .ac-modal.hidden{display:none}
  .ac-modal__inner{position:relative;background:#202530;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 16px 36px rgba(0,0,0,.45);padding:18px;min-width:320px;max-width:440px;width:92%;color:#fff}
  .ac-modal__close{position:absolute;right:10px;top:10px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer}
  .ac-title{font-size:18px;margin:0 0 6px}
  .ac-sub{opacity:.8;margin:0 0 12px;font-size:14px}
  .ac-hint{opacity:.65;margin:8px 0 0;font-size:12px}
  .ac-or{display:flex;align-items:center;gap:10px;opacity:.6;margin:12px 0}
  .ac-or:before,.ac-or:after{content:"";height:1px;background:rgba(255,255,255,.2);flex:1}
  .ac-actions{display:flex;gap:10px;justify-content:center;margin:8px 0 0}
  .btn{padding:9px 14px;border-radius:10px;font-size:14px;cursor:pointer;border:1px solid transparent}
  .btn-primary{background:#be0036;color:#fff;border-color:#be0036}
  .btn-outline{background:transparent;color:#fff;border-color:rgba(255,255,255,.3)}
  .btn-ghost{background:transparent;color:#fff;border-color:transparent;opacity:.9}
  .ac-tg{display:flex;justify-content:center}
</style>

  <!-- –≤–∞—à –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ–≥–æ–¥–∞/–ø–æ–∏—Å–∫/–∏ —Ç.–¥.) -->
 <script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const show = el => el && el.classList.remove('hidden');
  const hide = el => el && el.classList.add('hidden');

  const tgModal     = $('#authTgModal');
  const avatarModal = $('#avatarModal');

  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  async function getJSON(url){
    const r = await fetch(url, { credentials: 'same-origin' });
    return r.json();
  }
  async function postForm(url, fd){
    const r = await fetch(url, {
      method:'POST',
      body: fd,
      credentials:'same-origin',
      headers:{'X-CSRFToken': csrftoken},
    });
    const ok = r.ok;
    let data = {};
    try{ data = await r.json(); }catch{}
    if(!ok) throw new Error(data.message || ('HTTP ' + r.status));
    return data;
  }

  // === –≥–ª–∞–≤–Ω–æ–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º /auth/me/ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ===
  async function refreshAuthUI(){
    try{
      const me = await getJSON('/auth/me/');
      if (me.authenticated){
        // —Å–∫—Ä—ã—Ç—å TG –ø–æ–ø–∞–ø
        hide(tgModal);

        // –∞–≤–∞—Ç–∞—Ä –≤ —Ç–∞–±–µ
        if(me.avatar_url){
          const navAva = $('#navAvatar');
          if (navAva) {
            navAva.innerHTML =
              `<img src="${me.avatar_url}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover">`;
          }
        } else {
          // –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –∑–∞–≥—Ä—É–∑–∏—Ç—å, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –ø—Ä–æ—Å–∏–ª–∏
          if (avatarModal && avatarModal.classList.contains('hidden')) {
            show(avatarModal);
          }
        }
        return true;
      } else {
        // –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å TG –ø–æ–ø–∞–ø
        if (tgModal && tgModal.classList.contains('hidden')) show(tgModal);
        return false;
      }
    }catch(_){
      // —Å–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî –Ω–∏—á–µ–≥–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ
      return false;
    }
  }

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  refreshAuthUI();

  // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Telegram,
  // —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è ‚Äî –æ–ø—Ä–∞—à–∏–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ
  let tries = 0;
  const timer = setInterval(async () => {
    tries += 1;
    const ok = await refreshAuthUI();
    if (ok || tries > 20){ // ~20 —Ä–∞–∑ * 1.5s ‚âà 30c
      clearInterval(timer);
    }
  }, 1500);

  // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
  $$('#authTgModal [data-close]').forEach(b => b.addEventListener('click', ()=> hide(tgModal)));
  $$('#avatarModal [data-close]').forEach(b => b.addEventListener('click', ()=> hide(avatarModal)));

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
  const formAvatar = $('#formAvatar');
  formAvatar?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(formAvatar);
    const file = fd.get('avatar');
    if(!(file && ['image/jpeg','image/png','image/webp'].includes(file.type))){
      alert('–î–æ–ø—É—Å—Ç–∏–º—ã JPG/PNG/WebP'); return;
    }
    if(file.size > 5*1024*1024){
      alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)'); return;
    }
    const btn = formAvatar.querySelector('button[type="submit"]');
    if (btn){ btn.dataset._text = btn.textContent; btn.disabled = true; btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶'; }
    try{
      const data = await postForm('/auth/upload-avatar/', fd);
      if(!data.successful){ alert(data.message||'–û—à–∏–±–∫–∞'); return; }
      hide(avatarModal);
      // –ø–æ—Å–ª–µ –∞–ø–¥–µ–π—Ç–∞ ‚Äî —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏–º UI
      refreshAuthUI();
    }catch(err){
      alert(err.message || '–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
    }finally{
      if (btn){ btn.disabled = false; btn.textContent = btn.dataset._text || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
    }
  });

  // ESC –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(!tgModal?.classList.contains('hidden')) hide(tgModal);
      if(!avatarModal?.classList.contains('hidden')) hide(avatarModal);
    }
  });
})();
</script>

  <script async src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="{{ TELEGRAM_BOT_NAME|default:'travel_ayolclub_bot' }}"
        data-size="large"
        data-userpic="false"
        data-auth-url="/auth/telegram/callback/?next={{ request.path }}"
        data-request-access="write"
        data-onauth="onTelegramAuth(user)"></script>

<script>
  // –≠—Ç–æ—Ç —Ö—É–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –≤–∏–¥–∂–µ—Ç–µ.
  // –ú—ã –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É (–ø–æ–ø–∞–¥—ë–º –Ω–∞ /auth/telegram/callback/, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω—ë–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É).
  function onTelegramAuth(user){
    try { console.debug('TG user:', user); } catch(e){}
    // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ Telegram –ø–æ—á–µ–º—É-—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–ª —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ data-auth-url,
    // —Ñ–æ—Ä—Å–Ω—ë–º ourselves:
    if (!location.href.includes('/auth/telegram/callback/')) {
      const p = new URLSearchParams(user).toString();
      location.href = '/auth/telegram/callback/?' + p + '&next=' + encodeURIComponent(location.pathname);
    }
  }
</script>

</body>
</html>
