{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A CLUB TRAVEL ‚Äî Index</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

  <!-- –ö–†–£–ì–õ–û–ï –§–û–ù–û–í–û–ï –í–ò–î–ï–û -->
  <div class="bg-circle" aria-hidden="true">
    <video id="bgCircleVideo"
           class="bg-circle__video"
           autoplay
           muted
           loop
           playsinline
           preload="metadata"
           poster="{% static 'img/bg-poster.jpg' %}">
      <source src="{% static 'video/bg-hero.mp4' %}" type="video/mp4">
    </video>
  </div>

  <!-- –®–∞–ø–∫–∞ -->
  <header class="topbar">
    <div class="container">
      <div class="greet">
        <div id="hi" class="hi">–°–∞–ª–æ–º, –º–µ“≥–º–æ–Ω üëã</div>
      </div>

      <div class="top-actions">
        <div class="weather" title="Local weather">
          <div class="icon" aria-hidden="true"></div>
          <div class="weatherTexts">
            <span id="weatherTextTop">Weather</span>
            <button id="openAuthBtn" class="btn btn-primary" style="margin-left:12px;">
              –í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </button>
            <span id="weatherText">15¬∞C</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="container">
    <section class="layout">
      <div class="copy">
        <div class="copy-grid">
          <span id="locationBadge" class="badge">Loading location‚Ä¶</span>
          <h1 class="title" id="heroTitle">A CLUB<br/>TRAVEL</h1>
          <h1 class="titleDesc" id="heroTitleDesctop">A CLUB TRAVEL</h1>

          <!-- –¢—Ä–∏–≥–≥–µ—Ä –ø–æ–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞ -->
          <button class="search-trigger" id="searchTrigger" aria-label="Search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
              <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–∏—Å–∫–∞ -->
      <div class="search-overlay" id="searchOverlay" aria-hidden="true">
        <form class="search-bar" role="search" id="searchForm">
          <input class="search-field" id="searchField" type="text" placeholder="Search‚Ä¶" enterkeyhint="search" />
          <button type="button" class="search-close" id="searchClose" aria-label="Close">‚úï</button>
        </form>
      </div>
    </section>

    <!-- TRIPS SLIDER -->
    <section class="trips">
      <h2 class="trips-title">Popular trips</h2>

      <div class="trip-scroller" id="tripScroller" aria-label="Trip slider">
        {% for t in trips %}
        <article class="trip-card theme-{{ t.theme }}">
          <div class="trip-pill" aria-hidden="true"></div>

          <!-- –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–∏–∫–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ CSS) -->
          <button class="trip-fav" aria-label="Add to favorites"></button>

          <!-- —Å—Ç—Ä–∞–Ω–∞ -->
          <div class="trip-top">
            <span class="flag">
              <img src="https://flagcdn.com/24x18/{{ t.country.iso2|lower }}.png" width="24" height="18" alt="">
              {{ t.country.name|upper }}
            </span>
          </div>

          <!-- –Ω–∞–∑–≤–∞–Ω–∏–µ -->
          <h3 class="trip-name">{{ t.title_full }}</h3>

          <!-- –º–µ—Ç–∞: –¥–∞—Ç–∞ —Å—Ç—Ä–æ–∫–æ–π + –ø–æ–¥ –Ω–µ–π –∞–≤–∞—Ç–∞—Ä–∫–∏ (–∑–∞–≥–ª—É—à–∫–∏) -->
          <div class="trip-meta">
            <div class="meta-col">
              <div class="cal">
                <i class="cal-ic" aria-hidden="true"></i>
                <span class="date">{{ t.date_range_str }}</span>
              </div>
              <div class="faces">
                <img src="https://i.pravatar.cc/48?img=12" alt="">
                <img src="https://i.pravatar.cc/48?img=32" alt="">
                <img src="https://i.pravatar.cc/48?img=18" alt="">
                <img src="https://i.pravatar.cc/48?img=44" alt="">
                <span class="more">+{{ t.booked }}</span>
              </div>
            </div>

            <!-- —Å—Ç—Ä–µ–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ -->
            <a href="{% url 'trip_detail' t.slug %}" class="trip-go" aria-label="Open trip"></a>
          </div>
        </article>
        {% empty %}
          <p style="opacity:.7">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤.</p>
        {% endfor %}
      </div>
    </section>
  </main>

  <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <div class="bottom-inner">
      <a class="tab tab--home active_page" href="{% url 'index' %}"><span class="ico"></span></a>
      <a class="tab tab--support" href="#"><span class="ico"></span></a>
      <a class="tab tab--saved" href="#"><span class="ico"></span></a>
      <a class="tab tab--profile" href="#"><span class="ico" id="navAvatar"></span></a>
    </div>
  </nav>

  <!-- Desktop-only hint -->
  <div id="deviceHint" class="device-hint" role="dialog" aria-modal="true" aria-labelledby="deviceHintTitle" aria-describedby="deviceHintText">
    <div class="device-hint__card">
      <div class="device-hint__icon" aria-hidden="true">
        <svg viewBox="0 0 48 48" width="48" height="48">
          <rect x="14" y="4" width="20" height="40" rx="4" fill="#111"/>
          <rect x="16.5" y="8" width="15" height="28" rx="2" fill="#fff"/>
          <circle cx="24" cy="39" r="2.5" fill="#fff"/>
        </svg>
      </div>
      <h3 id="deviceHintTitle">–î–ª—è –ª—É—á—à–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∑–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
      <p id="deviceHintText" class="device-hint__sub">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
      <button id="deviceHintContinue" class="device-hint__btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –º–æ–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
    </div>
  </div>

  <script src="{% static 'js/script.js' %}"></script>

  <!-- ===== AUTH MODAL (Login / Register) ===== -->
  <div id="authModal" class="ac-modal hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="ac-modal__inner">
      <button class="ac-modal__close" data-ac-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>

      <h3 id="authTitle" class="ac-title">A CLUB ‚Äî –≤—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>

      <div class="ac-tabs" role="tablist">
        <button class="ac-tab ac-tab--active" data-tab="login" role="tab" aria-selected="true">–í–æ–π—Ç–∏</button>
        <button class="ac-tab" data-tab="register" role="tab" aria-selected="false">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>

      <!-- LOGIN -->
      <div class="ac-pane" data-pane="login">
        <form id="formLogin" class="ac-form" novalidate>
          <label class="ac-label">
            <span>Gmail</span>
            <input type="email" name="email" placeholder="example@gmail.com" autocomplete="email" required />
          </label>
          <label class="ac-label">
            <span>–ü–∞—Ä–æ–ª—å</span>
            <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
          </label>
          <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
        </form>
      </div>

      <!-- REGISTER (Step 1 ‚Üí Step 2 ‚Üí Step 3) -->
      <div class="ac-pane hidden" data-pane="register">
        <!-- STEP 1: –¥–∞–Ω–Ω—ã–µ -->
        <form id="regStep1" class="ac-form" novalidate>
          <label class="ac-label">
            <span>–ò–º—è</span>
            <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ñ–∞—Ö–æ–Ω–≥–∏—Ä" autocomplete="name" required />
          </label>
          <label class="ac-label">
            <span>Gmail</span>
            <input type="email" name="email" placeholder="example@gmail.com" autocomplete="email" required />
          </label>
          <label class="ac-label">
            <span>–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
            <input type="tel" name="phone" placeholder="+998 xx xxx xx xx" autocomplete="tel" />
          </label>
          <label class="ac-label">
            <span>–ü–∞—Ä–æ–ª—å</span>
            <input type="password" name="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password" minlength="6" required />
          </label>
          <button type="submit" class="btn btn-primary">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
          <div class="ac-help">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ—á—Ç—É.</div>
        </form>

        <!-- STEP 2: –∫–æ–¥ -->
        <form id="regStep2" class="ac-form hidden" novalidate>
          <label class="ac-label">
            <span>–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞</span>
            <input type="text" name="code" placeholder="123456" inputmode="numeric" autocomplete="one-time-code" required />
          </label>
          <button type="submit" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button type="button" class="btn btn-ghost" id="resendCodeBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –µ—â—ë —Ä–∞–∑</button>
        </form>

        <!-- STEP 3: –∞–≤–∞—Ç–∞—Ä -->
        <form id="regStep3" class="ac-form hidden" enctype="multipart/form-data" novalidate>
          <label class="ac-label">
            <span>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä (jpg/png/webp)</span>
            <input type="file" name="avatar" accept=".jpg,.jpeg,.png,.webp" required />
          </label>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏</button>
          <div class="ac-help">–ê–≤–∞—Ç–∞—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.</div>
        </form>
      </div>

      <div id="authError" class="ac-error hidden" role="alert"></div>
    </div>
  </div>

  <!-- ===== Inline styles –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ===== -->
  <style>
    .ac-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .ac-modal.hidden{display:none}
    .ac-modal__inner{position:relative;background:#202530;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 16px 36px rgba(0,0,0,.45);padding:18px;min-width:320px;max-width:460px;width:92%;color:#fff}
    .ac-modal__close{position:absolute;right:10px;top:10px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer}
    .ac-title{margin:0 0 10px;font-weight:800}
    .ac-tabs{display:flex;gap:8px;margin-bottom:12px}
    .ac-tab{flex:1;border:1px solid rgba(255,255,255,.12);background:transparent;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .ac-tab--active{background:#be0036;border-color:#be0036}
    .ac-pane.hidden{display:none}
    .ac-form{display:grid;gap:10px}
    .ac-label{display:grid;gap:6px;font-size:13px}
    .ac-form input[type="text"],
    .ac-form input[type="email"],
    .ac-form input[type="password"],
    .ac-form input[type="tel"],
    .ac-form input[type="file"]{
      padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#262b36;color:#fff
    }
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:700}
    .btn-primary{background:#be0036;color:#fff;border-color:#be0036}
    .btn-ghost{background:transparent;color:#fff;border-color:rgba(255,255,255,.25)}
    .ac-help{font-size:12px;opacity:.8}
    .ac-error{margin-top:10px;background:#5a1327;border:1px solid #be0036;color:#fff;padding:10px;border-radius:10px}
    .hidden{display:none}
  </style>

  <!-- ===== –õ–æ–≥–∏–∫–∞ –ø–æ–ø–∞–ø–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ===== -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const show = el => el && el.classList.remove('hidden');
    const hide = el => el && el.classList.add('hidden');
    const on  = (el, ev, fn) => el && el.addEventListener(ev, fn);

    const authModal = $('#authModal');
    const openBtn   = $('#openAuthBtn');
    const errorBox  = $('#authError');

    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF –∏–∑ cookie
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length === 2) return parts.pop().split(';').shift();
    }
    function csrfHeaders() {
      const csrftoken = getCookie('csrftoken');
      return csrftoken ? {'X-CSRFToken': csrftoken} : {};
    }
    function setError(msg){
      if(!msg){ hide(errorBox); errorBox.textContent=''; return; }
      errorBox.textContent = msg;
      show(errorBox);
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    on(openBtn, 'click', ()=> {
      resetForms();
      show(authModal);
    });
    $$('#authModal [data-ac-close]').forEach(b=>on(b,'click',()=> hide(authModal)));

    // –¢–∞–±—ã
    $$('.ac-tab').forEach(btn=>{
      on(btn,'click',()=>{
        $$('.ac-tab').forEach(b=> b.classList.remove('ac-tab--active'));
        btn.classList.add('ac-tab--active');
        const target = btn.dataset.tab;
        $$('.ac-pane').forEach(p=> p.classList.toggle('hidden', p.dataset.pane !== target));
        setError('');
      });
    });

    // ====== LOGIN ======
    on($('#formLogin'),'submit', async (e)=>{
      e.preventDefault();
      setError('');
      const fd = new FormData(e.target);
      try{
        const r = await fetch('/auth/login/', {
          method:'POST',
          headers: csrfHeaders(),
          body: fd
        });
        const data = await r.json();
        if(!data.successful){ setError(data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); return; }
        hide(authModal);
        await postLoginUIUpdate(data);
      }catch(err){
        setError('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    // ====== REGISTER FLOW ======
    const reg1 = $('#regStep1');   // –∏–º—è, –ø–æ—á—Ç–∞, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–∞—Ä–æ–ª—å -> –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥
    const reg2 = $('#regStep2');   // –≤–≤–æ–¥ –∫–æ–¥–∞
    const reg3 = $('#regStep3');   // –∞–≤–∞—Ç–∞—Ä

    let regEmail = '';
    let regPassword = '';
    let regName = '';
    let regPhone = '';

    function resetForms(){
      // –ß–∏—Å—Ç–∏–º –≤—Å–µ –ø–æ–ª—è/–æ—à–∏–±–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      $('#formLogin')?.reset();
      reg1?.reset(); reg2?.reset(); reg3?.reset();
      show(reg1); hide(reg2); hide(reg3);
      setError('');
    }

    // Step 1 ‚Üí –∑–∞–ø—Ä–æ—Å –∫–æ–¥–∞
    on(reg1, 'submit', async (e)=>{
      e.preventDefault();
      setError('');
      const fd = new FormData(reg1);
      regName = String(fd.get('name')||'').trim();
      regEmail = String(fd.get('email')||'').trim();
      regPhone = String(fd.get('phone')||'').trim();
      regPassword = String(fd.get('password')||'');
      if(!regName || !regEmail || regPassword.length < 6){
        setError('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏, –ø–æ—á—Ç—ã –∏ –ø–∞—Ä–æ–ª—è (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤).');
        return;
      }
      try{
        const fdReq = new FormData();
        fdReq.append('name', regName);
        fdReq.append('email', regEmail);
        if(regPhone) fdReq.append('phone', regPhone);
        fdReq.append('password', regPassword);

        const r = await fetch('/auth/request-code/', {
          method:'POST',
          headers: csrfHeaders(),
          body: fdReq
        });
        const data = await r.json();
        if(!data.successful){ setError(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥'); return; }
        hide(reg1); show(reg2);
        alert('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É');
      }catch(err){
        setError('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
    on($('#resendCodeBtn'), 'click', async ()=>{
      setError('');
      if(!regEmail){ setError('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥ 1.'); return; }
      try{
        const fd = new FormData();
        fd.append('email', regEmail);
        const r = await fetch('/auth/request-code/', {
          method:'POST',
          headers: csrfHeaders(),
          body: fd
        });
        const data = await r.json();
        if(!data.successful){ setError(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥'); return; }
        alert('–ö–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É');
      }catch(err){
        setError('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    // Step 2 ‚Üí –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞
    on(reg2, 'submit', async (e)=>{
      e.preventDefault();
      setError('');
      const fd = new FormData(reg2);
      const code = String(fd.get('code')||'').trim();
      if(!code){ setError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞.'); return; }
      try{
        const f = new FormData();
        f.append('email', regEmail);
        f.append('code', code);
        const r = await fetch('/auth/verify/', {
          method:'POST',
          headers: csrfHeaders(),
          body: f
        });
        const data = await r.json();
        if(!data.successful){ setError(data.message || '–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω'); return; }
        hide(reg2); show(reg3);
      }catch(err){
        setError('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    // Step 3 ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –∏ –∞–≤—Ç–æ-–≤—Ö–æ–¥
    on(reg3, 'submit', async (e)=>{
      e.preventDefault();
      setError('');
      const fd = new FormData(reg3);
      if(!fd.get('avatar')){ setError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä.'); return; }
      try{
        const r = await fetch('/auth/upload-avatar/', {
          method:'POST',
          headers: csrfHeaders(),
          body: fd
        });
        const data = await r.json();
        if(!data.successful){ setError(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä'); return; }

        // –ü–æ—Å–ª–µ –∞–≤–∞—Ç–∞—Ä–∞ ‚Äî —Å—Ä–∞–∑—É –ª–æ–≥–∏–Ω–∏–º –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ –ø–∞—Ä–µ email+password
        const loginForm = new FormData();
        loginForm.append('email', regEmail);
        loginForm.append('password', regPassword);
        const r2 = await fetch('/auth/login/', {
          method:'POST',
          headers: csrfHeaders(),
          body: loginForm
        });
        const loginData = await r2.json();
        if(!loginData.successful){ setError(loginData.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–≤—Ö–æ–¥–∞'); return; }

        hide(authModal);
        await postLoginUIUpdate(loginData);
      }catch(err){
        setError('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    async function postLoginUIUpdate(me){
      try{
        // –û–±–Ω–æ–≤–∏–º —à–∞–ø–∫—É: –∞–≤–∞—Ç–∞—Ä/–∏–º—è
        const resp = await fetch('/auth/me/');
        const data = await resp.json();
        if(data && data.authenticated){
          const navAv = $('#navAvatar');
          const hi = $('#hi');
          if(data.name) hi.textContent = `–°–∞–ª–æ–º, ${data.name} üëã`;
          if(data.avatar_url){
            if(navAv) navAv.innerHTML = `<img src="${data.avatar_url}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover">`;
            if(openBtn){
              openBtn.outerHTML = `<img src="${data.avatar_url}" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover">`;
            }
          }else if(openBtn){
            openBtn.textContent = data.name || data.email || '–ü—Ä–æ—Ñ–∏–ª—å';
          }
        }
        // –û–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        // location.reload(); // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ
      }catch(_){}
    }

    // –ê–≤—Ç–æ-–∑–∞–ø—Ä–æ—Å /auth/me/ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    (async ()=>{
      try{
        const r = await fetch('/auth/me/');
        const data = await r.json();
        if(data && data.authenticated){
          const hi = $('#hi');
          if(data.name) hi.textContent = `–°–∞–ª–æ–º, ${data.name} üëã`;
          if(data.avatar_url){
            $('#navAvatar').innerHTML =
              `<img src="${data.avatar_url}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover">`;
            if(openBtn){
              openBtn.outerHTML =
                `<img src="${data.avatar_url}" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover">`;
            }
          }else if(openBtn){
            openBtn.textContent = data.name || data.email || '–ü—Ä–æ—Ñ–∏–ª—å';
          }
        }
      }catch(_){}
    })();

    // –ò–∑–±–µ–∂–∞—Ç—å "—Å—Ç–∞—Ä—ã—Ö" –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π/–ø–æ–ø–∞–ø–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ —Ä–∞–Ω–µ–µ —á—Ç–æ-—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏)
    // –ù–∏—á–µ–≥–æ –Ω–µ —Ö—Ä–∞–Ω–∏–º –≤ localStorage –¥–ª—è auth ‚Äî –≤—Å—ë –Ω–∞ —Å–µ—Å—Å–∏—è—Ö/–∫—É–∫–∞—Ö.
    try{
      ['aclub_user','aclub_avatar'].forEach(k=> localStorage.removeItem(k));
    }catch(_){}
  })();
  </script>

</body>
</html>
